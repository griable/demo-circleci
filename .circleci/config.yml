executors:
  node:
    docker:
      - image: circleci/node:erbium

aliases:
  restore_cache: &restore_cache
    restore_cache:
      name: Restore Npm Package Cache
      keys:
        - v{{ .Environment.versionCache }}-deps-{{ .Branch }}-{{ checksum "package-lock.json" }}-{{ checksum ".circleci/config.yml" }}

  install_node_modules: &install_node_modules
    run:
      name: Install NPM dependencies
      command: npm install

  save_cache: &save_cache
    save_cache:
      name: Save NPM package cache
      key: v{{ .Environment.versionCache }}-deps-{{ .Branch }}-{{ checksum "package-lock.json" }}-{{ checksum ".circleci/config.yml" }}
      paths:
        - ./node_modules
        - /usr/local/bin/netlify
        - /usr/local/lib/node_modules/netlify-cli

version: 2.1

orbs:
  lighthouse-check: foo-software/lighthouse-check@0.0.13
  pa11yci: nebulab/pa11yci@1.0.0

jobs:
  install:
    parameters:
      page:
        type: string
    executor: node
    steps:
      - checkout
      - <<: *restore_cache
      - <<: *install_node_modules
      - <<: *save_cache
  build_and_lint:
    parameters:
      page:
        type: string
    executor: node
    steps:
      - checkout
      - <<: *restore_cache
      - <<: *install_node_modules
      - run:
          name: Print value
          command: echo << parameters.page >>
      - run:
          name: Build Public
          command: npm run generate
      - persist_to_workspace:
          root: ./
          paths:
            - dist
  bump_version:
    parameters:
      page:
        type: string
    executor: node
    steps:
      - checkout
      - <<: *restore_cache
      - <<: *install_node_modules
      # - run:
      #     name: Bump package version
      #     command: |
      #       branch=$(git log -1 --pretty="%s" | grep -Po '(?<=\/).*' || true;)
      #       semverBump=$(case $branch in
      #         *"feat/"*) echo "minor" ;;
      #         *"bug/"*) echo "patch" ;;
      #         *"hot/"*) echo "patch" ;;
      #         *"patch/"*) echo "patch" ;;
      #         *"hotfix/"*) echo "patch" ;;
      #         *) echo false ;;
      #       esac)
      #       if [ $semverBump != false ]
      #       then
      #         npm version --no-git-tag-version $semverBump || true
      #         DATE=`date +%Y.%m`
      #         VERSION=$(jq -r .version package.json)
      #         sed -i "/version/c\  \"version\": \"${VERSION}+$DATE.$CIRCLE_BUILD_NUM\"," package.json
      #         git push origin master
      #         git push --tags
      #         exit 0;
      #       fi
      - add_ssh_keys:
          fingerprints:
            - "b2:79:96:4b:8e:30:e4:b8:c0:5f:de:0c:c0:f8:1b:f5"
      - run:
          name: Setup Git
          command: |
            git config user.email "gabriel.slama@akqa.com"
            git config user.name "Gabriel Slama"
      - run:
          name: Versioning
          command: npm version patch -m "version %s [skip ci]"
      - run:
          name: Push tag & changes to github.com
          command: git push --set-upstream origin ${CIRCLE_BRANCH}

  test:
    parameters:
      page:
        type: string
    executor: node
    steps:
      - checkout
      - <<: *restore_cache
      - <<: *install_node_modules
      - attach_workspace:
          at: ./
      - run:
          name: Check bunlde size
          command: npm run bundlewatch
  zip_and_store:
    parameters:
      page:
        type: string
    executor: node
    steps:
      - checkout
      - <<: *restore_cache
      - <<: *install_node_modules
      - attach_workspace:
          at: ./
      - run:
          name: Compress Artifacts
          command: zip -r myartifact.zip dist
      - store_artifacts:
          path: archive.zip
          destination: archive
  deploy:
    parameters:
      page:
        type: string
    executor: node
    steps:
      - checkout
      - attach_workspace:
          at: ./
      - <<: *restore_cache
      - <<: *install_node_modules
      - run:
          name: print variable
          command: echo '${NETLIFY_AUTH_TOKEN_<< parameters.page >})'
      - run:
          name: set variable
          command: echo 'export NETLIFY_AUTH_TOKEN="${NETLIFY_AUTH_TOKEN_<< parameters.page >>}"' >> $BASH_ENV
      - run:
          name: install netlify cli
          command: sudo npm install -g --unsafe-perm --silent netlify-cli
      - run:
          name: Print path
          command: |
            which netlify
      - run:
          name: deploy site to netlify
          command: |
            netlify deploy --json | jq .deploy_url > ./echo-output
      - persist_to_workspace:
          root: ./
          paths:
            - echo-output
  run_ligthouse:
    parameters:
      page:
        type: string
    executor: lighthouse-check/default
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Write variable
          command: echo 'export NETLIFY_DEPLOY_URL="$(cat ./echo-output)"' >> $BASH_ENV
      - lighthouse-check/audit:
          urls: $NETLIFY_DEPLOY_URL

workflows:
  version: 2.1
  build_and_deploy:
    jobs:
      - install:
          name: install-v<< matrix.page >>
          matrix:
            parameters:
              page: ['TENNIS']
      - build_and_lint:
          name: build_and_lint-v<< matrix.page >>
          matrix:
            parameters:
              page: ['TENNIS']
          requires:
            - install-v<< matrix.page >>
      - test:
          name: test-v<< matrix.page >>
          matrix:
            parameters:
              page: ['TENNIS']
          requires:
            - build_and_lint-v<< matrix.page >>
      - deploy:
          name: deploy-v<< matrix.page >>
          matrix:
            parameters:
              page: ['TENNIS']
          requires:
            - test-v<< matrix.page >>
      # - pa11yci/a11y-audit:
      #     name: pa11yci-v<< matrix.page >>
      #     matrix:
      #       parameters:
      #         page: ['TENNIS']
      #     custom_url_command: |
      #       if [[ -f ./echo-output ]]; then
      #         sed -i -e "s#https://demo-circleci.netlify.app#`cat ./echo-output`#g" .pa11yci
      #       fi
      #     filters:
      #       branches:
      #         ignore: master
      #     requires:
      #       - deploy-v<< matrix.page >>
      - run_ligthouse:
          name: run_ligthouse-v<< matrix.page >>
          matrix:
            parameters:
              page: ['TENNIS']
          requires:
            - deploy-v<< matrix.page >>
      - zip_and_store:
          name: zip_and_store-v<< matrix.page >>
          matrix:
            parameters:
              page: ['TENNIS']
          requires:
            - test-v<< matrix.page >>
      # - bump_version:
      #     requires:
      #       - build_and_lint
      #     filters:
      #       branches:
      #         only:
      #           - develop
      #           - master
